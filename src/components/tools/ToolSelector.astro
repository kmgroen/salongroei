---
import { getLangFromUrl } from '../../i18n/utils';

interface Props {
  tools: Array<{
    data: {
      name: string;
      slug: string;
      tagline: { nl: string; en: string };
      imageUrl: string;
      accentColor: string;
    };
  }>;
}

const { tools } = Astro.props;
const lang = getLangFromUrl(Astro.url);
---

<div class="bg-white rounded-xl border-2 border-gray-200 p-6">
  <div class="flex items-center justify-between mb-4">
    <h3 class="font-display text-xl font-black text-expert-navy">
      {lang === 'nl' ? 'Selecteer Tools om te Vergelijken' : 'Select Tools to Compare'}
    </h3>
    <button
      id="compare-button"
      disabled
      class="bg-primary text-white px-6 py-2.5 rounded-xl font-bold text-sm shadow-lg shadow-primary/20 hover:scale-105 transition-transform disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
    >
      {lang === 'nl' ? 'Vergelijk' : 'Compare'}
      <span id="selected-count" class="ml-2">(0)</span>
    </button>
  </div>

  <p class="text-sm text-expert-navy/60 mb-6">
    {lang === 'nl'
      ? 'Kies 2-4 tools om een gedetailleerde vergelijking te zien'
      : 'Choose 2-4 tools to see a detailed comparison'
    }
  </p>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    {tools.map((tool) => (
      <label class="flex items-center gap-3 p-4 rounded-xl border-2 border-gray-200 cursor-pointer hover:border-primary hover:bg-primary/5 transition-all">
        <input
          type="checkbox"
          name="tool-selection"
          value={tool.data.slug}
          class="w-5 h-5 text-primary rounded focus:ring-primary focus:ring-2"
        />
        <div class="flex-1 flex items-center gap-3">
          <img
            src={tool.data.imageUrl}
            alt={tool.data.name}
            class="w-12 h-12 rounded-lg object-cover"
          />
          <div>
            <div class="font-semibold text-expert-navy">{tool.data.name}</div>
            <div class="text-xs text-expert-navy/60">{tool.data.tagline[lang]}</div>
          </div>
        </div>
      </label>
    ))}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const checkboxes = document.querySelectorAll<HTMLInputElement>('input[name="tool-selection"]');
    const compareButton = document.getElementById('compare-button') as HTMLButtonElement;
    const selectedCount = document.getElementById('selected-count');

    function updateCompareButton() {
      const selected = Array.from(checkboxes).filter(cb => cb.checked);
      const count = selected.length;

      if (selectedCount) {
        selectedCount.textContent = `(${count})`;
      }

      if (compareButton) {
        compareButton.disabled = count < 2 || count > 4;
      }

      // Disable checkboxes if 4 are already selected
      checkboxes.forEach(cb => {
        if (!cb.checked && count >= 4) {
          cb.disabled = true;
          cb.parentElement?.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
          cb.disabled = false;
          cb.parentElement?.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      });
    }

    checkboxes.forEach(cb => {
      cb.addEventListener('change', updateCompareButton);
    });

    compareButton?.addEventListener('click', () => {
      const selected = Array.from(checkboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);

      if (selected.length >= 2 && selected.length <= 4) {
        const params = new URLSearchParams();
        selected.forEach(slug => params.append('tools', slug));
        window.location.href = `/tools/compare?${params.toString()}`;
      }
    });
  });
</script>
